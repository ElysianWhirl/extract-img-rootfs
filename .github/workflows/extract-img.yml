#==========================================================================
# Copyright (C) 2024 Chewy Mage 
# https://github.com/Haris131/extract-img  
#==========================================================================

name: Extract img file

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      type_file:
        description: "Select type file"
        required: false
        default: "img.xz"
        type: choice
        options:
          - img.xz
          - img.gz
      img_url:
        description: "Set the url img file"
        required: true
        type: string
      rename:
        description: "Set the boot & rootfs name"
        required: true
        type: string

env:
  TZ: Asia/Jakarta

jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up environment
      run: |
        sudo timedatectl set-timezone "$TZ"
        sudo apt-get update -qq
        sudo apt-get install -y wget python3 python3-pip p7zip-full lsb-release

        # Google Drive
        pip3 install --no-cache-dir gdown

        # Mega.nz
        DISTRIB_RELEASE=$(lsb_release -rs)
        wget -q "https://mega.nz/linux/repo/xUbuntu_${DISTRIB_RELEASE}/amd64/megacmd-xUbuntu_${DISTRIB_RELEASE}_amd64.deb"
        sudo apt install -y ./megacmd-xUbuntu_${DISTRIB_RELEASE}_amd64.deb

    - name: Download image file
      env:
        IMG_URL: ${{ github.event.inputs.img_url }}
        TYPE_FILE: ${{ github.event.inputs.type_file }}
      run: |
        set -e
        mkdir -p ./download
        cd ./download

        echo "ðŸŒ Downloading from: $IMG_URL"

        if [[ "$IMG_URL" == *"drive.google.com"* ]]; then
          FILE_ID=""
          if [[ "$IMG_URL" == *"/d/"* ]]; then
            FILE_ID=$(echo "$IMG_URL" | cut -d'/' -f5)
          elif [[ "$IMG_URL" == *"id="* ]]; then
            FILE_ID=$(echo "$IMG_URL" | grep -oP 'id=\K[^&]*')
          fi
          if [ -z "$FILE_ID" ]; then
            echo "âŒ Failed to parse Google Drive file ID"
            exit 1
          fi
          gdown "$FILE_ID" -O "file.$TYPE_FILE"

        elif [[ "$IMG_URL" == *"mediafire.com"* ]]; then
          echo "ðŸ“¥ Attempting direct MediaFire download..."
          if wget --no-check-certificate --timeout=30 --tries=2 "$IMG_URL" -O "temp_file" 2>/dev/null; then
            if file temp_file | grep -q "HTML"; then
              echo "âš ï¸ Got HTML page (not file). Extracting direct link..."
              rm -f temp_file
              PAGE=$(curl -sL "$IMG_URL")
              DIRECT_URL=$(echo "$PAGE" | grep -oP 'href="\Khttps://download[0-9]+\.mediafire\.com/[^"]+')
              if [ -z "$DIRECT_URL" ]; then
                echo "âŒ Could not extract direct download URL from MediaFire page"
                echo "ðŸ’¡ Tip: Use a direct download link (starts with https://download*.mediafire.com/)"
                exit 1
              fi
              wget --no-check-certificate "$DIRECT_URL" -O "file.$TYPE_FILE"
            else
              mv temp_file "file.$TYPE_FILE"
            fi
          else
            echo "âš ï¸ Direct download failed. Trying to extract link from HTML..."
            PAGE=$(curl -sL "$IMG_URL")
            DIRECT_URL=$(echo "$PAGE" | grep -oP 'href="\Khttps://download[0-9]+\.mediafire\.com/[^"]+')
            if [ -z "$DIRECT_URL" ]; then
              echo "âŒ Failed to get MediaFire direct link"
              exit 1
            fi
            wget --no-check-certificate "$DIRECT_URL" -O "file.$TYPE_FILE"
          fi

        elif [[ "$IMG_URL" == *"mega.nz"* ]]; then
          mega-get "$IMG_URL" .
          if ls *."$TYPE_FILE" 1> /dev/null 2>&1; then
            mv *."$TYPE_FILE" "file.$TYPE_FILE"
          else
            echo "âŒ No .$TYPE_FILE found in Mega download"
            ls -la
            exit 1
          fi

        else
          wget --no-check-certificate "$IMG_URL" -O "file.$TYPE_FILE"
        fi

        if [ ! -f "file.$TYPE_FILE" ]; then
          echo "âŒ File file.$TYPE_FILE not found after download"
          exit 1
        fi

        echo "âœ… Download successful"

    - name: Extract and split firmware
      env:
        RENAME: ${{ github.event.inputs.rename }}
        TYPE_FILE: ${{ github.event.inputs.type_file }}
      run: |
        set -e
        mkdir -p boot rootfs img
        cd download

        if [ "$TYPE_FILE" = "img.gz" ]; then
          gunzip -f file.img.gz
        elif [ "$TYPE_FILE" = "img.xz" ]; then
          unxz -f file.img.xz
        else
          echo "âŒ Unsupported file type: $TYPE_FILE"
          exit 1
        fi

        if [ ! -f file.img ]; then
          echo "âŒ file.img missing after decompression"
          exit 1
        fi

        LOOP_DEV=$(sudo losetup -fP --show file.img)
        echo "ðŸ” Loop device: $LOOP_DEV"

        sudo mkdir -p ../boot ../rootfs
        sudo mount "${LOOP_DEV}p1" ../boot
        sudo mount "${LOOP_DEV}p2" ../rootfs

        (cd ../boot && sudo tar -czf "../img/${RENAME}-boot.tar.gz" .)
        (cd ../rootfs && sudo tar -czf "../img/${RENAME}-rootfs.tar.gz" .)

        sudo umount ../boot ../rootfs || true
        sudo losetup -d "$LOOP_DEV" || true

        echo "PACKAGED_STATUS=success" >> "$GITHUB_ENV"

    - name: Upload boot artifact
      uses: actions/upload-artifact@v4
      if: env.PACKAGED_STATUS == 'success'
      with:
        name: ${{ github.event.inputs.rename }}-boot
        path: img/${{ github.event.inputs.rename }}-boot.tar.gz

    - name: Upload rootfs artifact
      uses: actions/upload-artifact@v4
      if: env.PACKAGED_STATUS == 'success'
      with:
        name: ${{ github.event.inputs.rename }}-rootfs
        path: img/${{ github.event.inputs.rename }}-rootfs.tar.gz

    - name: Set release tag
      id: tag
      run: echo "tag_name=extract-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT

    - name: Create release and upload assets
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: img/*
        tag: ${{ steps.tag.outputs.tag_name }}
        file_glob: true
        overwrite: true
        body: |
          Firmware extracted from:
          - URL: ${{ github.event.inputs.img_url }}
          - Type: ${{ github.event.inputs.type_file }}
          - Name: ${{ github.event.inputs.rename }}

    - name: Cleanup old workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3
